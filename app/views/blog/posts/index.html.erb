<div class="blog-scope">
  <div class="container mx-auto px-8 sm:px-6 lg:px-8 py-24">
    <header class="mb-8">
      <h1 class="text-6xl text-black">Blog</h1>
    </header>

    <nav class="mb-12" role="tablist">
      <ul class="flex flex-wrap gap-x-3 gap-y-3 text-lg">
        <li>
          <% all_posts_active = params[:category_name].blank? && params[:tag_name].blank? %>
          <%= link_to "All Posts", blog_index_path,
              role: "tab",
              aria_selected: all_posts_active,
              class: "block no-underline px-4 py-2 rounded-full border border-black transition-all duration-200 ease-in-out
                      #{ all_posts_active ?
                          'bg-black text-white' :
                          'bg-white text-black hover:-translate-x-1 hover:-translate-y-1 hover:shadow-[3px_3px_#000]' }" %>
        </li>
        <% ["Creators", "Tips & tricks", "Product updates", "Community"].each do |static_category_name| %>
          <% parameterized_category = static_category_name.parameterize %>
          <% is_active_static = params[:category_name] == parameterized_category %>
          <li>
            <%= link_to static_category_name, blog_index_path(category_name: parameterized_category),
                role: "tab",
                aria_selected: is_active_static,
                class: "block no-underline px-4 py-2 rounded-full border border-black transition-all duration-200 ease-in-out
                        #{ is_active_static ?
                            'bg-black text-white' :
                            'bg-white text-black hover:-translate-x-1 hover:-translate-y-1 hover:shadow-[3px_3px_#000]' }" %>
          </li>
        <% end %>
      </ul>
    </nav>

    <% if @active_category.blank? %>
      <div class="flex flex-col-reverse lg:flex-row lg:gap-[1.875rem] mb-8 items-start">
        <section class="w-full lg:w-[calc(67%-0.9375rem)] mb-0 lg:mb-0">
          <% if @featured_post %>
            <%= render "blog/shared/post_card", post: @featured_post, title_size_class: "text-3xl lg:text-4xl", max_tags: 4 %>
          <% else %>
            <p class="text-gray-600 p-8 border-2 border-dashed border-gray-300 rounded text-center min-h-[300px] flex items-center justify-center">No featured post available.</p>
          <% end %>
        </section>
        <div class="w-full lg:w-[calc(33%-0.9375rem)] mb-8 lg:mb-0">
          <div class="h-full shadow-sm flex flex-col">
            <h3 class="text-base border-y border-gray-300 py-2 flex-shrink-0">Product updates</h3>
            <% if @product_updates.any? %>
              <ul class="flex-grow overflow-y-auto">
                <% @product_updates.each do |post| %>
                  <li class="py-4 border-b border-gray-300">
                    <%= link_to blog_post_path(slug: post.slug),
                        class: "block flex justify-between items-end no-underline text-black hover:text-pink-600 group" do %>
                      <div class="grid override grid-cols-1 gap-1">
                        <h4 class="font-normal text-2xl mb-0.5">
                          <%= post.title.presence || "Untitled Post" %>
                        </h4>
                        <% if post.date %><%# Helper handles nil, but keeping conditional render for structure %>
                          <p class="text-base text-gray-500 pb-0.5"><%= format_blog_date(post.date) %></p>
                        <% end %>
                      </div>
                      <div class="flex-shrink-0 ml-3 mr-1 p-2 border border-gray-400 rounded-md w-10 h-10 flex items-center justify-center self-end transition-all duration-200 ease-in-out group-hover:-translate-x-px group-hover:-translate-y-px group-hover:shadow-[2px_2px_0_0_#000]">
                        <%= image_tag "icons/arrow-right.svg", width: 20, height: 20 %>
                      </div>
                    <% end %>
                  </li>
                <% end %>
              </ul>
              <div class="mt-1 flex-shrink-0">
                <%= link_to blog_index_path(category_name: "product-updates"), class: "inline-flex items-center text-black hover:underline" do %>
                  See all
                  <%= image_tag "icons/arrow-right.svg", width: 18, height: 18, class: "ml-1.5" %>
                <% end %>
              </div>
            <% else %>
              <p class="text-gray-500">No product updates.</p>
            <% end %>
          </div>
        </div>
      </div>

      <section class="mt-8">
        <% displayed_slugs = [@featured_post&.slug].compact %>
        <% posts_for_grid = (@posts + @product_updates).uniq(&:slug).reject { |p| displayed_slugs.include?(p.slug) }.first(9) %>

        <% if posts_for_grid.any? %>
          <div class="grid override grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-8">
            <% posts_for_grid.each do |post| %>
              <%= render "blog/shared/post_card", post: post %>
            <% end %>
          </div>
        <% else %>
          <% if !@featured_post %>
            <p class="text-gray-600 col-span-full text-center py-10">No posts found.</p>
          <% else %>
             <p class="text-gray-600 col-span-full text-center py-10">No additional posts found.</p>
          <% end %>
        <% end %>
      </section>

    <% else %>
      <section>
        <% posts_for_grid = @posts %>
        <% if posts_for_grid.any? %>
          <div class="grid override grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <% posts_for_grid.each do |post| %>
              <%= render "blog/shared/post_card", post: post %>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-600 text-center py-10">No posts found in this category.</p>
        <% end %>
      </section>
    <% end %>

  </div>
</div>

<%= render "home/shared/footer" %>
